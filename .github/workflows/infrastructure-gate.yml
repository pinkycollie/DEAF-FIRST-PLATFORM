name: Infrastructure Readiness Gate

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  check-infrastructure:
    name: Verify Infrastructure Completion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Infrastructure Readiness Check
        id: infra-check
        run: |
          cd ${{ github.workspace }}
          bash scripts/check-infrastructure-ready.sh

      - name: Infrastructure Status
        if: success()
        run: |
          echo "‚úÖ Infrastructure readiness check passed"
          echo "All required services are configured:"
          echo "  - DeafAUTH (/auth): Authentication service"
          echo "  - PinkSync (sync): Real-time synchronization service"
          echo "  - FibonRose (trust): Trust and optimization engine"

      - name: Block on Infrastructure Failure
        if: failure()
        run: |
          echo "‚ùå Infrastructure is not ready for deployment"
          echo "Please complete the infrastructure setup before pushing code."
          echo ""
          echo "Required components:"
          echo "  1. DeafAUTH service configuration"
          echo "  2. PinkSync service configuration"
          echo "  3. FibonRose service configuration"
          echo "  4. Complete Terraform infrastructure files"
          echo "  5. Environment-specific configurations"
          echo ""
          echo "See terraform/README.md for deployment instructions."
          exit 1

  deployment-gate:
    name: Deployment Gate Check
    runs-on: ubuntu-latest
    needs: check-infrastructure
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Services Configuration
        run: |
          echo "Validating core services..."
          
          # Check deafauth
          if [ ! -f "services/deafauth/package.json" ]; then
            echo "‚ùå DeafAUTH service not properly configured"
            exit 1
          fi
          echo "‚úÖ DeafAUTH (/auth) - Ready"
          
          # Check pinksync
          if [ ! -f "services/pinksync/package.json" ]; then
            echo "‚ùå PinkSync service not properly configured"
            exit 1
          fi
          echo "‚úÖ PinkSync (sync) - Ready"
          
          # Check fibonrose
          if [ ! -f "services/fibonrose/package.json" ]; then
            echo "‚ùå FibonRose service not properly configured"
            exit 1
          fi
          echo "‚úÖ FibonRose (trust) - Ready"

      - name: Verify Terraform Configuration
        run: |
          echo "Verifying Terraform infrastructure..."
          
          if [ ! -d "terraform" ]; then
            echo "‚ùå Terraform directory not found"
            exit 1
          fi
          
          # Check for required terraform files
          required_files=("main.tf" "variables.tf" "outputs.tf" "deafauth.tf" "pinksync.tf" "fibonrose.tf")
          for file in "${required_files[@]}"; do
            if [ ! -f "terraform/${file}" ]; then
              echo "‚ùå Required Terraform file ${file} not found"
              exit 1
            fi
          done
          
          echo "‚úÖ Terraform configuration complete"

      - name: Deployment Approval
        run: |
          echo "========================================="
          echo "üöÄ DEPLOYMENT GATE PASSED"
          echo "========================================="
          echo ""
          echo "Infrastructure Status: ‚úÖ READY"
          echo ""
          echo "Core Services Configured:"
          echo "  ‚úÖ DeafAUTH (/auth) - Authentication & User Management"
          echo "  ‚úÖ PinkSync (sync) - Real-time Synchronization"
          echo "  ‚úÖ FibonRose (trust) - Trust & Optimization Engine"
          echo ""
          echo "Infrastructure Components:"
          echo "  ‚úÖ Terraform configuration complete"
          echo "  ‚úÖ Service configurations validated"
          echo "  ‚úÖ Environment setup verified"
          echo ""
          echo "Platform Evolution:"
          echo "  ü§ñ Ready for autonomous operation with Vertex AI"
          echo "  üìö RAG system ready for community feedback integration"
          echo "  üîÑ Distributed system architecture configured"
          echo ""
          echo "‚úÖ Code push approved - Infrastructure is complete"
          echo "========================================="

  notify-status:
    name: Notify Infrastructure Status
    runs-on: ubuntu-latest
    needs: [check-infrastructure, deployment-gate]
    if: always()
    steps:
      - name: Summary
        run: |
          if [ "${{ needs.check-infrastructure.result }}" == "success" ] && [ "${{ needs.deployment-gate.result }}" == "success" ]; then
            echo "‚úÖ All infrastructure checks passed"
            echo "Platform is ready for deployment and autonomous evolution"
          else
            echo "‚ö†Ô∏è Infrastructure checks incomplete"
            echo "Please review and complete infrastructure setup"
          fi
