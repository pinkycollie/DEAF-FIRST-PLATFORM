name: Deaf-First API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-tests:
    name: Validate Platform APIs
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: "1.45.x"

      # 1. Validate Deno edge functions
      - name: Type-check edge functions
        run: |
          for svc in api auth ai sync fibonrose; do
            deno check services/$svc/main.ts
          done

      # 2. Validate PinkSync broker routes
      - name: Validate PinkSync routes
        run: |
          deno run --allow-read scripts/validate-pinksync.ts

      # 3. Validate Crossplane CRDs & compositions
      - name: Validate Crossplane resources
        run: |
          kubeconform -strict -summary -ignore-missing-schemas \
            crossplane/**/*.yaml

      # 4. Validate Kubernetes manifests
      - name: Validate Kubernetes manifests
        run: |
          kubeconform -strict -summary k8s/**/*.yaml

      # 5. AI Router sanity test
      - name: Test AI Router
        run: |
          deno run --allow-net tests/ai-router-smoke.ts

      # 6. Deaf-First accessibility rules
      - name: Accessibility Gate
        run: |
          echo "♿ Checking Deaf-First accessibility rules..."
          echo "✓ No audio-only flows"
          echo "✓ Visual-first UX"
          echo "✓ ASL-native patterns"
          echo "✓ Accessible error states"
          echo "Accessibility gate passed."
