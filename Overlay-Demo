<!DOCTYPE html>
<html>
<head>
  <title>PinkSync Overlay Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f0f0;
    }
    #main-content {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    video {
      max-width: 100%;
      border-radius: 8px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      background: #ff69b4;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #ff1493;
    }
    #overlay {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: white;
      border: 3px solid #ff69b4;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
      resize: both;
      overflow: auto;
      min-width: 160px;
      min-height: 120px;
      cursor: move;
      display: flex;
      flex-direction: column;
    }
    #overlay-header {
      background: #ff69b4;
      color: white;
      padding: 5px 10px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }
    #overlay-video {
      width: 100%;
      height: auto;
      display: block;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }
    #controls {
      margin-top: 20px;
      padding: 10px;
      background: #eee;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="main-content">
    <h1>üü£ PinkSync Overlay Demo</h1>
    <p>This shows how an interpreter overlay could appear on any website (like Twitch, Zoom, etc.).</p>
    <p>The overlay window is <strong>draggable</strong> and <strong>resizable</strong> (grab the bottom‚Äëright corner).</p>
    <video id="main-video" controls>
      <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div id="controls">
      <button id="camera-btn">üì∑ Use Camera (Live Interpreter)</button>
      <button id="fetch-btn">üì• Fetch Sample Video (Pre‚Äërecorded)</button>
      <button id="stop-btn">‚èπÔ∏è Stop Overlay</button>
    </div>
    <p><small>In a real app, fetching would get an interpreter's video URL from your Deno backend, and WebRTC would handle live streaming.</small></p>
  </div>

  <!-- Overlay window -->
  <div id="overlay">
    <div id="overlay-header">
      <span>üü£ PinkSync Interpreter</span>
      <span style="cursor:pointer;" id="close-btn">‚úñ</span>
    </div>
    <video id="overlay-video" autoplay muted playsinline></video>
  </div>

  <script>
    (function() {
      const overlay = document.getElementById('overlay');
      const overlayVideo = document.getElementById('overlay-video');
      const header = document.getElementById('overlay-header');
      const closeBtn = document.getElementById('close-btn');
      
      let currentStream = null;

      // Draggable functionality
      let isDragging = false;
      let offsetX, offsetY;

      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - overlay.offsetLeft;
        offsetY = e.clientY - overlay.offsetTop;
        overlay.style.cursor = 'grabbing';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        overlay.style.left = (e.clientX - offsetX) + 'px';
        overlay.style.top = (e.clientY - offsetY) + 'px';
        overlay.style.right = 'auto';
        overlay.style.bottom = 'auto';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        overlay.style.cursor = 'move';
      });

      // Close button
      closeBtn.addEventListener('click', () => {
        stopOverlay();
      });

      // Helper to stop any playing stream
      function stopOverlay() {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }
        overlayVideo.srcObject = null;
        overlayVideo.src = '';
      }

      // Camera button: get user's camera as live interpreter feed
      document.getElementById('camera-btn').addEventListener('click', async () => {
        stopOverlay();
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          overlayVideo.srcObject = stream;
          currentStream = stream;
          overlayVideo.style.display = 'block';
        } catch (err) {
          alert('Camera access denied: ' + err.message);
        }
      });

      // Fetch button: fetch a sample video and play it in overlay
      document.getElementById('fetch-btn').addEventListener('click', async () => {
        stopOverlay();
        // Use a public domain video (Big Buck Bunny) as sample
        const videoUrl = 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
        try {
          const response = await fetch(videoUrl);
          if (!response.ok) throw new Error('Fetch failed');
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          overlayVideo.src = url;
          overlayVideo.style.display = 'block';
        } catch (err) {
          alert('Error fetching video: ' + err.message);
        }
      });

      // Stop button
      document.getElementById('stop-btn').addEventListener('click', () => {
        stopOverlay();
        overlayVideo.src = '';
        overlayVideo.srcObject = null;
      });

      // Initial overlay visibility (hidden by default? We'll show it with a sample? Let's show camera on load for demo)
      // Optionally auto-start camera for demo (commented out to avoid permission popup without user action)
      // document.getElementById('camera-btn').click();
    })();
  </script>
</body>
</html>